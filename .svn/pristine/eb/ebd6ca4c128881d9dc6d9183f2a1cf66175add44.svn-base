package gui;

import java.awt.Color;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.util.ArrayList;
import java.util.List;

import javax.swing.BorderFactory;
import javax.swing.JButton;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JSeparator;
import javax.swing.JTextArea;
import javax.swing.JTextField;
import javax.swing.UIManager;

import net.miginfocom.swing.MigLayout;

import org.joda.time.LocalDate;

import com.toedter.calendar.JDateChooser;

import domein.Leertraject;
import domein.LeertrajectController;
import domein.LeertrajectSpec;
import domein.Medewerker;
import domein.pattern.observer.Observer;

public class NieuwTrajectPanel extends JPanel  implements Observer{
	
	/**
	 * 
	 */
	private static final long serialVersionUID = 3182733315485037005L;
	private JLabel lblTitel;
	private JTextField txtTitel;
	private JLabel lblCode;
	private JTextField txtCode;
	private JLabel lblDoelgroep;
	private JTextField txtDoelgroep;
	private JLabel lblOmschrijving;
	private JTextArea txaOmschrijving;
	private JScrollPane scrOmschrijving;
	private JLabel lblLiveDatum;
	private JDateChooser fieldLiveDatum;
	private JLabel lblBeschikVan;
	private JDateChooser fieldBeschikVan;
	private JLabel lblBeschikTot;
	private JDateChooser fieldBeschikTot;
	private JButton clear;
	private JButton opslaan;
	private JButton btnAddUsers;
	private JLabel lblWerknemers;
	private JTextField txtWerknemers;
	private LeertrajectController controller;
	private List<Medewerker> medewerkersLijst;
	
	
	public NieuwTrajectPanel(LeertrajectController controller) {
		super();
		initGUI(controller);
	}



	private void initGUI(LeertrajectController controller){
		this.setLayout(new MigLayout());
		this.controller = controller;
		
		setFocusable(true);
		JPanel panelNT = new JPanel(new MigLayout("wrap","[left][grow,fill,350::]"));
		panelNT.setBackground(new Color(250,250,250));
		panelNT.setBorder(BorderFactory.createLineBorder(Color.LIGHT_GRAY));
		this.addSeparator("Algemeen");
			{
				lblCode = new JLabel("Leertrajectcode :");
				txtCode = new JTextField();
				txtCode.setName("Code");
				panelNT.add(lblCode,"w min!");
				panelNT.add(txtCode,"w 50!,split 3");
			}
			{
				lblDoelgroep = new JLabel("Doelgroep :");
				txtDoelgroep = new JTextField();
				panelNT.add(lblDoelgroep,"w min!");
				panelNT.add(txtDoelgroep,"growx");
			}
			{
				lblWerknemers = new JLabel("Medewerkers :");
				txtWerknemers = new JTextField();
				panelNT.add(lblWerknemers,"w min!");
				panelNT.add(txtWerknemers,"growx,split 2");
			}
			{
				btnAddUsers = new JButton("...");
				panelNT.add(btnAddUsers);
			}
			{
				lblTitel = new JLabel("Titel :");
				txtTitel = new JTextField();
				panelNT.add(lblTitel,"w min!");
				panelNT.add(txtTitel,"growx");
			}
			{
				lblOmschrijving = new JLabel("Omschrijving :");
				txaOmschrijving = new JTextArea();
				txaOmschrijving.setLineWrap(true);
				txaOmschrijving.setWrapStyleWord(true);
				scrOmschrijving = new JScrollPane(txaOmschrijving);
				scrOmschrijving.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_ALWAYS);
				panelNT.add(lblOmschrijving,"w min!");
				panelNT.add(scrOmschrijving,"growx,h 210!");
			}
			
		this.addSeparator("Datum");
			{
				lblLiveDatum = new JLabel("Live datum :");
				fieldLiveDatum = new JDateChooser();
				fieldLiveDatum.addPropertyChangeListener(new PropertyChangeListener() {
					
					@Override
					public void propertyChange(PropertyChangeEvent evt) {
						if(fieldLiveDatum.getDate() != null && fieldBeschikVan.getDate() == null){
							fieldBeschikVan.setDate(LocalDate.fromDateFields(fieldLiveDatum.getDate()).minusMonths(1).toDate());
						}
						if(fieldLiveDatum.getDate() != null && fieldBeschikTot.getDate() == null){
							fieldBeschikTot.setDate(LocalDate.fromDateFields(fieldLiveDatum.getDate()).plusMonths(1).toDate());
						}
					}
				});
				fieldLiveDatum.getCalendarButton().setFocusCycleRoot(false);
				fieldLiveDatum.setDateFormatString("dd/MM/yyyy");
				panelNT.add(lblLiveDatum,"w min!");
				panelNT.add(fieldLiveDatum,"growx");
			}
			{
				lblBeschikVan = new JLabel("Beschikbaar van :");
				fieldBeschikVan = new JDateChooser();
				fieldBeschikVan.setDateFormatString("dd/MM/yyyy");
				panelNT.add(lblBeschikVan,"w min!");
				panelNT.add(fieldBeschikVan,"growx");
			}
			{
				lblBeschikTot = new JLabel("Beschikbaar tot :");
				fieldBeschikTot = new JDateChooser();
				fieldBeschikTot.setDateFormatString("dd/MM/yyyy");
				panelNT.add(lblBeschikTot,"w min!");
				panelNT.add(fieldBeschikTot,"growx");
				
			}
		this.add(panelNT);
		{
			JPanel filler = new JPanel(new MigLayout("","push[right]"));
			filler.setBackground(new Color(250,250,250));
			filler.setBorder(BorderFactory.createLineBorder(Color.LIGHT_GRAY));
			{
				clear = new JButton("Clear");
				clear.setMnemonic(KeyEvent.VK_L);
				clear.addActionListener(new ActionListener() {
					
					@Override
					public void actionPerformed(ActionEvent e) {

					}
				});
				filler.add(clear,"split 2,tag back");
			}
			{
				opslaan = new JButton("Opslaan");
				opslaan.setMnemonic(KeyEvent.VK_L);
				opslaan.addActionListener(new ActionListener() {

					@Override
					public void actionPerformed(ActionEvent e) {
						if(validateFields()) {
							voegLeertrajectToe();
							// switch naar beheer panel
						}
					}
				});
				filler.add(opslaan,"tag next");
			}
			this.add(filler,"south,pad -1 0 0 0");
		}
	}
	
	

	private void addSeparator(String text)
	{
		JLabel l = new JLabel(text);
		l.setForeground(new Color(35,100,240));

		this.add(l, "gapbottom 1, span, split 2, aligny center");
		this.add((new JSeparator()), "gapleft rel, growx");
	}
	
	private LeertrajectSpec maakLeertrajectSpecAan() {
		LeertrajectSpec leertrajectSpec = new LeertrajectSpec();
		leertrajectSpec.setTitel(txtTitel.getText());
		leertrajectSpec.setOmschrijving(txaOmschrijving.getText());
		leertrajectSpec.setDoelgroep(txtDoelgroep.getText());
		leertrajectSpec.setLeertrajectCode(txtCode.getText());
		leertrajectSpec.setStartdatum(LocalDate.fromDateFields(fieldLiveDatum.getDate()));
		leertrajectSpec.setBeschikbaarheidVan(LocalDate.fromDateFields(fieldBeschikVan.getDate()));
		leertrajectSpec.setBeschikbaarheidTot(LocalDate.fromDateFields(fieldBeschikTot.getDate()));
		medewerkersLijst = new ArrayList<>();
		leertrajectSpec.setMedewerkersLijst(medewerkersLijst);
		return leertrajectSpec;
		
		// ? medewerkerlijst	
	}

	
	
	private boolean validateFields() {
		boolean validate = true;
		if(txtCode.getText().isEmpty() || txtCode.getText().length() > 10) {
			validate = false;
			txtCode.setBorder(BorderFactory.createLineBorder(Color.RED));
		} else txtCode.setBorder(UIManager.getBorder("TextField.border"));
		
		if(txtTitel.getText().isEmpty() || !txtTitel.getText().matches("[a-zA-Z0-9À-ž\\s-]*")) {
			validate = false;
			txtTitel.setBorder(BorderFactory.createLineBorder(Color.RED));
		} else txtTitel.setBorder(UIManager.getBorder("TextField.border"));
		
		if(txaOmschrijving.getText().isEmpty()) {
			validate = false;
			scrOmschrijving.setBorder(BorderFactory.createLineBorder(Color.RED));
		} else scrOmschrijving.setBorder(BorderFactory.createLineBorder(Color.GRAY));
		
		if(txtDoelgroep.getText().isEmpty()) {
			validate = false;
			txtDoelgroep.setBorder(BorderFactory.createLineBorder(Color.RED));
		} else txtDoelgroep.setBorder(UIManager.getBorder("TextField.border"));
		
		if(fieldLiveDatum.getDate() == null) {
			validate = false;
			fieldLiveDatum.getDateEditor().getUiComponent().setBorder(BorderFactory.createLineBorder(Color.RED));
		} else fieldLiveDatum.getDateEditor().getUiComponent().setBorder(UIManager.getBorder("TextField.border"));
		
		if(fieldBeschikVan.getDate() == null || LocalDate.fromDateFields(fieldLiveDatum.getDate()).isBefore(LocalDate.fromDateFields(fieldBeschikVan.getDate()))) {
			validate = false;
			fieldBeschikVan.getDateEditor().getUiComponent().setBorder(BorderFactory.createLineBorder(Color.RED));
		} else fieldBeschikVan.getDateEditor().getUiComponent().setBorder(UIManager.getBorder("TextField.border"));
		
		if(fieldBeschikTot.getDate() == null || LocalDate.fromDateFields(fieldBeschikTot.getDate()).isBefore(LocalDate.fromDateFields(fieldBeschikVan.getDate()))
											 || LocalDate.fromDateFields(fieldBeschikTot.getDate()).isBefore(LocalDate.fromDateFields(fieldLiveDatum.getDate()))) {
			validate = false;
			fieldBeschikTot.getDateEditor().getUiComponent().setBorder(BorderFactory.createLineBorder(Color.RED));
		} else fieldBeschikTot.getDateEditor().getUiComponent().setBorder(UIManager.getBorder("TextField.border"));
		
		return validate;
	}
	
	protected void voegLeertrajectToe() {

		
		controller.voegLeertrajectToe(controller.maakLeertrajectAan(this.maakLeertrajectSpecAan()));
		

	}
	
	
	public void updateFields(){
		txtTitel.setText(controller.getGeselecteerdLeertraject().getLeertrajectSpec().getTitel());
		txaOmschrijving.setText(controller.getGeselecteerdLeertraject().getLeertrajectSpec().getOmschrijving());
		txtCode.setText("");
		fieldBeschikTot.setDate(null);
		fieldBeschikVan.setDate(null);
		fieldLiveDatum.setDate(null);
	}
	
	@Override
	public void update(Object object) {
		if(object instanceof Leertraject){
			updateFields();
		}
	}
}

        |open input parameterbestand
        |perform connectieDB
        |perform until einde
        |    select trajectcode from tblLeertrajecten where actief = true en gearchiveerd = true
        |    perform deactiveerTraject
        |end-perform
        |perform close-connectieDB
        |close parameterbestand
        |
        |
        |deactiveerTraject :
        |perform until einde
        |    select userID from tblLeertraject/deelnemer where trajectcode = :trajectcode
        |    remove link userID met trajectcode
        |    if (!userID exist in tblLeertraject/deelnemer)
        |	remove user from tblDeelnemer
        |end-perform
        |update traject in DB


       IDENTIFICATION DIVISION.
       PROGRAM-ID. DeactivatieTrajecten.
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.      
       FILE-CONTROL.
           SELECT parameter-invoer 
           ASSIGN TO "parameters.txt"
           ORGANIZATION LINE SEQUENTIAL
           FILE STATUS IS parameter-status.
       DATA DIVISION.
       FILE SECTION.
       FD parameter-invoer.
       copy parameter_record.
       WORKING-STORAGE SECTION.
       01 statuscodes.
           05 parameter-status          PIC X(2).
       01 jdbc-string                   PIC X(100).
       01 condities                     PIC X.
           05 conditie1                 PIC X. 
                88 eot                                VALUE HIGH-VALUES.
                |end-of-trajectlist 
           05 conditie2                 PIC X.
                88 eod                                VALUE HIGH-VALUES.
                |end-of-deelnemerlist           
           05 conditie3                 PIC X.
                88 gelinkte-user                      VALUE HIGH-VALUES.
       01 var-bool                      PIC 9         VALUE 1.
       01 errormessage                  PIC X(235).
       EXEC SQL BEGIN DECLARE SECTION
       END-EXEC.
      * 0 = succes , 100 = no data, -1 = failure
       01 SQLCODE                       PIC S9(3).
      * 00xxx is succes
       01 SQLSTATE                      PIC X(5).
       01 trajectcode                   PIC X(50).
       01 email                         PIC X(50).
       01 random-data                   PIC 9.
       EXEC SQL END DECLARE SECTION
       END-EXEC.
       PROCEDURE DIVISION.
       MAIN-PARAGRAPH.
       OPEN INPUT parameter-invoer
       PERFORM 2000-evaluatie-parameter-status
       
      *initial read - haalt jdbc-string uit parameters.txt
       READ parameter-invoer
         AT END SET eof OF parameter-record TO TRUE
           CALL "LogHandler" 
           USING "Het bestand 'parameters.txt' is leeg."
           STOP RUN
       END-READ
       MOVE parameter-record TO jdbc-string
       CLOSE parameter-invoer
       PERFORM 3000-connectDatabase
       
       EXEC SQL DECLARE trajectlist CURSOR FOR
         SELECT LeertrajectCode
         FROM tblLeertraject
         WHERE actief = :var-bool AND gearchiveerd = :var-bool
       END-EXEC
       
       EXEC SQL OPEN trajectlist END-EXEC
       
       PERFORM 3200-haal-traject-op
       PERFORM UNTIL eot
       INITIALIZE conditie2
       PERFORM 1000-verwerking-traject
       PERFORM 3600-deactiveer-traject
       PERFORM 3200-haal-traject-op
       END-PERFORM
       
       EXEC SQL CLOSE trajectlist END-EXEC
       EXEC SQL DEALLOCATE CURSOR trajectlist END-EXEC
       EXEC SQL COMMIT WORK END-EXEC
              
       PERFORM 3100-disconnectDatabase
       STOP RUN
       .
       
       1000-verwerking-traject.       
       EXEC SQL DECLARE deelnemerlist CURSOR FOR
         SELECT Email
         FROM tblLeertrajectDeelnemer
         WHERE LeertrajectCode = :trajectcode
       END-EXEC
       
       EXEC SQL OPEN deelnemerlist END-EXEC
       
       PERFORM 3300-haal-user-op
       PERFORM UNTIL eod
       INITIALIZE conditie3
       PERFORM 1500-verwerking-user
       PERFORM 3300-haal-user-op   
       END-PERFORM
       
       EXEC SQL CLOSE deelnemerlist END-EXEC
       EXEC SQL DEALLOCATE CURSOR deelnemerlist END-EXEC
       .
       
       1500-verwerking-user.
       PERFORM 3400-remove-link
       PERFORM 2500-evaluatie-user
       IF NOT gelinkte-user
       THEN PERFORM 3500-remove-user
       END-IF
       .
       
       2000-evaluatie-parameter-status.
       EVALUATE parameter-status
         WHEN "35" CALL "LogHandler" 
                  USING "Het bestand 'parameters.txt' is niet gevonden."
                  STOP RUN
       END-EVALUATE
       .
       
       2500-evaluatie-user.
       EXEC SQL
         SELECT COUNT(*)
         INTO :random-data
         FROM tblLeertrajectDeelnemer
         WHERE Email = :email
       END-EXEC

       EVALUATE random-data
         WHEN 0 SET gelinkte-user TO FALSE
         WHEN OTHER SET gelinkte-user TO TRUE
       END-EVALUATE
       .
       
       3000-connectDatabase.
       EXEC SQL
        CONNECT
        TO :jdbc-string  
        DRIVER "com.microsoft.sqlserver.jdbc.SQLServerDriver"                 
       END-EXEC
       .
       
       3100-disconnectDatabase.
       EXEC SQL
        DISCONNECT
       END-EXEC
       .
       
       3200-haal-traject-op.       
       EXEC SQL 
        FETCH trajectlist INTO :trajectcode
       END-EXEC
       
       EVALUATE SQLCODE
         WHEN 100 SET eot TO TRUE
         WHEN 0   SET eot TO FALSE
         WHEN OTHER SET eot TO TRUE
                  INITIALIZE errormessage
                  STRING "Fout met de communicatie met de databank "
                                        DELIMITED BY SIZE
                         "SQLCODE = "   DELIMITED BY SIZE
                         SQLCODE        DELIMITED BY SPACE
                         " SQLSTATE = " DELIMITED BY SIZE
                         SQLSTATE       DELIMITED BY SPACE
                  INTO errormessage
                  CALL "LogHandler" USING errormessage
       END-EVALUATE    
       .
        
       3300-haal-user-op.
       EXEC SQL
        FETCH deelnemerlist
        INTO :email
       END-EXEC
   
       EVALUATE SQLCODE
         WHEN 100 SET eod TO TRUE
         WHEN 0   SET eod TO FALSE
         WHEN OTHER SET eod TO TRUE
                  INITIALIZE errormessage
                  STRING "Fout met de communicatie met de databank "
                                        DELIMITED BY SIZE
                         "SQLCODE = "   DELIMITED BY SIZE
                         SQLCODE        DELIMITED BY SPACE
                         " SQLSTATE = " DELIMITED BY SIZE
                         SQLSTATE       DELIMITED BY SPACE
                  INTO errormessage
                  CALL "LogHandler" USING errormessage
       END-EVALUATE
       .
       
       3400-remove-link.
       EXEC SQL
        DELETE FROM tblLeertrajectDeelnemer
        WHERE Email = :email AND LeertrajectCode = :trajectcode
       END-EXEC
       
       EVALUATE SQLCODE
         WHEN NOT 0 INITIALIZE errormessage
                    STRING "Fout met de communicatie met de databank "
                                          DELIMITED BY SIZE
                           "SQLCODE = "   DELIMITED BY SIZE
                           SQLCODE        DELIMITED BY SPACE
                           " SQLSTATE = " DELIMITED BY SIZE
                           SQLSTATE       DELIMITED BY SPACE
                    INTO errormessage
                    CALL "LogHandler" USING errormessage
       END-EVALUATE
       .
       
       3500-remove-user.
       EXEC SQL
        DELETE FROM tblDeelnemer
        WHERE Email = :email
       END-EXEC
       
       EVALUATE SQLCODE
         WHEN NOT 0 INITIALIZE errormessage
                    STRING "Fout met de communicatie met de databank "
                                          DELIMITED BY SIZE
                           "SQLCODE = "   DELIMITED BY SIZE
                           SQLCODE        DELIMITED BY SPACE
                           " SQLSTATE = " DELIMITED BY SIZE
                           SQLSTATE       DELIMITED BY SPACE
                    INTO errormessage
                    CALL "LogHandler" USING errormessage
       END-EVALUATE
       .
       
       3600-deactiveer-traject.
       MOVE 0 TO var-bool
       EXEC SQL tblLeertraject
         UPDATE tblLeertraject
         SET Actief = :var-bool
         WHERE Leertrajectcode = :trajectcode
       END-EXEC

       EVALUATE SQLCODE
         WHEN NOT -1   INITIALIZE errormessage
                       STRING "Het traject "      DELIMITED BY SIZE
                       trajectcode         DELIMITED BY SPACE
                       " is gedeactiveerd" DELIMITED BY SIZE
                       INTO errormessage
                CALL "LogHandler" USING errormessage
         WHEN -1 INITIALIZE errormessage
                 STRING "Fout met de communicatie met de databank "
                                       DELIMITED BY SIZE
                        "SQLCODE = "   DELIMITED BY SIZE
                        SQLCODE        DELIMITED BY SPACE
                        " SQLSTATE = " DELIMITED BY SIZE
                        SQLSTATE       DELIMITED BY SPACE
                 INTO errormessage
                 CALL "LogHandler" USING errormessage
       END-EVALUATE
       .